<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>数据管理</title>
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
      <link rel="stylesheet" href="/other/bootstrap/css/bootstrap.min.css">
      <link rel="stylesheet" href="/other/bootstrap-table/bootstrap-table.min.css">
      <link rel="stylesheet" href="/other/bootstrap/css/bootstrap-datetimepicker.min.css">
      <link rel="stylesheet" href="/other/css/font-awesome.min.css">
      <link rel="stylesheet" href="/other/css/ionicons.min.css">
      <link rel="stylesheet" href="/other/dist/css/AdminLTE.min.css">
      <link rel="stylesheet" href="/other/dist/css/skins/_all-skins.min.css">
      <link rel="stylesheet" href="/other/quickSearch/quickSearch.css">
      <link rel="stylesheet" href="/css/index.css">
  </head>
  <body class="sidebar-mini skin-purple wysihtml5-supported">
      <div class="wrapper">
          <header class="main-header">
              <title>DMO | desert</title>
              <a class="logo">venus</a>
              <nav class="navbar navbar-static-top" role="navigation">
                  <a class="sidebar-toggle" data-toggle="offcanvas" role="button">
                      <span class="sr-only">Toggle navigation</span>
                  </a>
                 <div class="compy"><img height="50px" src="/img/logo.png"></div>
                  <div class="navbar-custom-menu">
                      <ul class="nav navbar-nav">
                          <li class="dropdown user user-menu">
                              <a class="dropdown-toggle" data-toggle="dropdown">
                                  <span class="hidden-xs">Admin</span>
                              </a>
                          </li>
                      </ul>
                  </div>
              </nav>
          </header>
      </div>
      <aside class="main-sidebar">
          <section class="sidebar">
              <ul class="sidebar-menu">
              </ul>
          </section>
      </aside>
      <div class="content-wrapper">
          <section class="content">
              <div class="row">
                  <ol class="breadcrumb">
                      <li><a>数据管理</a></li>
                      <li class="active">ClickHouse管理</li>
                  </ol>
              </div>
              <div class="row">
					<div id="toolbar">
					  <div class="form-inline" role="form">
					    <div class="form-group">
					      	<input name="databaseName" id="TBListDBNameId" class="form-control" type="text" placeholder="DataBaseName">
					    </div>
					   	<div class="form-group">
					   		<a class="btn btn-primary" href="javascript:showColumn()" role="button" id ="runId">查看列</a>
					    </div>
					  </div>
					</div>
					
					<div class="modal fade"  id="columnDialogId" tabindex="-1" role="dialog" aria-labelledby="">
					  <div class="modal-dialog modal-lg" style="width:1250px" role="document">
					    <div class="modal-content">
					      <div class="modal-body">
					      	<table
							 id ="columnTableId"
							 data-show-refresh="true"
							 data-pagination="true"
							 data-page-size="50"
							 data-response-handler="responseHandler"
							 data-toggle="table">
								<thead>
									<tr>
										<th data-field="database">数据库名称</th>
										<th data-field="table">表名称</th>
										<th data-field="name">字段名称</th>
										<th data-field="type">类型</th>
										<th data-field="comment">注释</th>
									</tr>
								</thead>
							</table>
				 	      </div>
					    </div>
					  </div>
					</div>
				
					<div class="modal fade" id="tipId" tabindex="-1" role="dialog" aria-labelledby="">
					  <div class="modal-dialog" role="document">
					    <div class="modal-content">
					      <div class="modal-body">
					      	<span id="tipValId"></span>
					      </div>
					    </div>
					  </div>
					</div>
				
					<div>
						<ul class="nav nav-tabs">
							<li class="active"><a href="#hostDivId" data-toggle="tab" >主机列表</a></li>
							<li><a href="#clusterTableDivId" data-toggle="tab">集群表</a></li>
							<li><a href="#DBId" data-toggle="tab">DB列表</a></li>
							<li><a href="#TBListId" data-toggle="tab">TB列表</a></li>
							<li><a href="#TBId" data-toggle="tab">DDL</a></li>
							<li><a href="#queryId" data-toggle="tab">QUERY</a></li>
						</ul>
						<div class="tab-content">
							<!-- 主机列表 -->
							<div class="tab-pane active" id="hostDivId">
								<table
								 id ="hostTableId"
								 data-show-refresh="true"
								 data-url="/venus/clickhouse/manager/getHostList"
								 data-pagination="true"
								 data-page-size="20"
								 data-response-handler="responseHandler"
								 data-toggle="table">
									<thead>
										<tr>
											<th data-field="hostName">主机名称</th>
											<th data-field="hostAddress">主机地址</th>
										</tr>
									</thead>
								</table>
							</div>
							<!-- 数据库列表 -->
							<div class="tab-pane" id="DBId">
								<table
								 id ="DBTableId"
								 data-show-refresh="true"
								 data-pagination="true"
								 data-page-size="20"
								 data-response-handler="responseHandler"
								 data-url="/venus/clickhouse/manager/getDatabaseList"
								 data-toggle="table">
									<thead>
										<tr>
											<th data-field="name">数据库名称</th>
											<th data-field="engine">引擎名称</th>
											<th data-field="data_path">data_path</th>
											<th data-field="metadata_path">metadata_path</th>
										</tr>
									</thead>
								</table>
							</div>
							<!--  表管理 -->
							<div class="tab-pane" id="TBId">
								<div class="panel panel-default">
									<div class="panel-body" >
										<form class="form-inline">
										  <div class="form-group">
										    <div class="input-group">
										      <div class="input-group-addon">库名称:</div>
										      <input type="text" class="form-control"  id="DBNameId" >
										    </div>
										  </div>
										  <div class="form-group">
										    <div class="input-group">
										      <div class="input-group-addon">表名称:</div>
										      <input type="text" class="form-control"  id="TBNameId" >
										    </div>
										  </div>
									    <div class="input-group">
									      <div class="input-group-btn">
									        <button class="btn btn-default dropdown-toggle" data-toggle="dropdown" style="background-color:#eee">是否创建集群表 <span class="caret"></span></button>
									        <ul class="dropdown-menu">
									          <li><a href="javascript:chose('YES')">YES</a></li>
									          <li><a href="javascript:chose('NO')">NO</a></li>
									        </ul>
									      </div>
									       <input type="text" class="form-control" id = "isDistributeTable" value="YES" />
									    </div>
									    <div class="input-group">
									      <div class="input-group-btn">
									        <a type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" style="background-color:#eee">集群表 <span class="caret"></span></a>
									        <ul class="dropdown-menu" id="clusterSelectId">
									        </ul>
									      </div>
									       <input type="text" class="form-control" id = "clusterInputId" value=""/>
									    </div>
										  <div class="form-group">
										    <div class="input-group">
										      <div class="input-group-addon">表散列方式:</div>
										      <input type="text" class="form-control" id="distrTypeId" placeholder="rand()">
										    </div>
										  </div>
										  <a class="btn btn-primary" href="#" role="button" id ="runId">RUN</a>
										</form>
										<!-- DDL语句 -->
										<textarea class="form-control" style="font-size:20px" rows="12" id ="sqlId"></textarea>
										<h4>执行结果:</h4>
										<table class="table" style="word-break:break-all; word-wrap:break-all;">
											<tr><td id="exeResultDivId"></td></tr>
										</table>
										<!-- 添加的表值 -->
										<table
										  id="tableId"
										  data-toggle="table">
											<thead>
												<tr>
													<th data-field="hostName">主机名称</th>
													<th data-field="database">数据库名称</th>
													<th data-field="name">表名称</th>
													<th data-field="engine">引擎名称</th>
													<th data-field="engine_full">引擎全名</th>
													<!-- <th data-field="create_table_query">表创建语句</th> -->
												</tr>
											</thead>
										</table>
									</div>
								</div>
							</div>
							<!-- 集群表管理 -->
							<div class="tab-pane" id="clusterTableDivId">
								<table
								 id ="clusterTableId"
								 data-show-refresh="true"
								 data-url="/venus/clickhouse/manager/getClusterList"
								 data-pagination="true"
								 data-page-size="20"
								 data-response-handler="responseHandler"
								 data-toggle="table">
									<thead>
										<tr>
											<th data-field="cluster">cluster</th>
											<th data-field="host_name">主机名称</th>
											<th data-field="shard_num">shard_num</th>
											<th data-field="shard_weight">shard_weight</th>
										</tr>
									</thead>
								</table>
							</div>
							<!-- 获取表列表 -->
							<div class="tab-pane" id="TBListId">
								<table
								 id ="TBListTableId"
								 data-single-select="true"
								 data-click-to-select="true"
								 data-toolbar="#toolbar"
								 data-toolbar-align="right"
								 data-query-params="queryParams"
								 data-url="/venus/clickhouse/manager/getDistrabuteTable"
								 data-pagination="true"
								 data-page-size="10"
								 data-show-refresh="true"
								 data-response-handler="responseHandler"
								 data-toggle="table">
									<thead>
										<tr>
											<th data-field="state" data-checkbox="true"></th>
											<th data-field="hostName">主机名称</th>
											<th data-field="database">数据库名称</th>
											<th data-field="name">表名称</th>
											<th data-field="engine">引擎名称</th>
											<th data-field="engine_full">引擎全名</th>
										</tr>
									</thead>
								</table>
							</div>
							<!-- query -->
							<div class="tab-pane" id="queryId">
								<div class="panel panel-default">
									<div class="panel-body">
										<form class="form-inline">
										    <div class="input-group">
										      <div class="input-group-btn">
										        <button class="btn btn-default dropdown-toggle" data-toggle="dropdown" style="background-color:#eee">格式化语句<span class="caret"></span></button>
										        <ul class="dropdown-menu">
										          <li><a href="#">YES</a></li>
										          <li><a href="#">NO</a></li>
										        </ul>
										      </div>
										       <input type="text" class="form-control" id = "isDistributeTable" value="YES" />
										    </div>
										  <a class="btn btn-primary" href="javascript:queryData()" role="button" id ="queryId">QUERY</a>
										</form>
										<textarea class="form-control" style="font-size:20px" rows="12" id ="querySQLId"></textarea>
										<div id="queryTableDivId">
											<table id ="queryTableId" 
				 								data-pagination="true"
												data-page-size="10" 
				 								data-toggle="table">
				 							</table>
										</div>
									</div><!-- query end -->
								  </div><!-- panel-body end -->
								</div><!-- panel end -->
						</div>
					</div>

              </div>
          </section>
      </div>
</body>
<script src="/other/require/require_jquery-2.1.4.js"></script>
<script src="/js/requireConfig.js"></script>
<script src="/js/menu/groupManagerList.js"></script>
 
<script type="text/javascript">
	require(['jquery','/other/bootstrap-table/bootstrap-table.js','https://cdn.www.sojson.com/js/common/jquery/jquery.format.js'],function($,bootstrapTable){
		$(function(){
			init();
		});
	})
	function init(){
		$("#DBNameId").keyup(function(){
			loadData($(this).val(),$("#TBNameId").val());
		})
		$("#TBNameId").keyup(function(){
			loadData($("#DBNameId").val(),$(this).val());
		})
		$("#runId").click(function(){
			clear();
			var sql = $("#sqlId").val();
			if(sql == null || sql == ''){
				exeResult("DDL语句不能为空",false);
				return;
			}
			var req ={
					"sql":sql,
					"databaseName":$("#DBNameId").val(),
					"tableName":$("#TBNameId").val(),
					"isDistributeTable":$("#isDistributeTable").val(),
					"cluster":$("#clusterInputId").val(),
					"destributeType":$("#distrTypeId").val()
				}
			$.ajax({
				url : "/venus/clickhouse/manager/execute",
				async : false,
				type : "POST",
				contentType : 'application/json',
				dataType : 'json',
				data :JSON.stringify(req),
				success : function(data) {
					if(data.success){
						loadData($("#DBNameId").val(),$("#TBNameId").val());
						exeResult("success",true);
					}else{
						exeResult(data.message,false);
					}
				}
			});
		})
		
		$("#sqlId").keyup(function(){
			var sql = $(this).val();
			clear();
			$.post("/venus/clickhouse/manager/extractDatabaseName"
				,{"sql":sql}
				,function(res){
					if(res.success){
						var arr = res.message.split(".");
						$("#DBNameId").val(arr[0]);
						$("#TBNameId").val(arr[1]);
						loadData(arr[0],arr[1]);	
					}else{
						$("#DBNameId").val("");
						$("#TBNameId").val("");
					}
				});
		})
		$("#TBListDBNameId").keyup(function(){
	      	$("#TBListTableId").bootstrapTable('refresh')
		})
		
		initCluster();
	}
	
	function chose(val){
		if(val == "YES"){
			$("#isDistributeTable").val("YES");
			initCluster();
		}
		if(val == "NO"){
			$("#isDistributeTable").val("NO");
			$("#clusterSelectId").empty();
			$("#clusterInputId").val("");
		}
	}
	
	function selectCluster(val){
		$("#clusterInputId").val(val);
	}
	function initCluster(){
		$.post("/venus/clickhouse/manager/getCluster",{},function(res){
			var data = res.pairs.retVal;
			if(data != null){
				var html ="";
				for(var i =0;i<data.length;i++){
					html += "<li><a href=javascript:selectCluster('"+data[i].cluster+"')>"+data[i].cluster+"</a></li>";
				}
				$("#clusterSelectId").empty();
				$("#clusterSelectId").append(html);
			}
		});
	}
	function clear(){
		var dom = $("#exeResultDivId");
		if(dom.hasClass("bg-danger")){
			dom.removeClass("bg-danger");
		}
		if(dom.hasClass("bg-success")){
			dom.removeClass("bg-success");
		}
		dom.html(" ");
	}
	
	function exeResult(msg,error){
		clear();
		var dom = $("#exeResultDivId");
		if(error != null && !error){
			dom.addClass("bg-danger");
		}else{
			dom.addClass("bg-success");
		}
		dom.html(getTime()+"{"+msg+"}");
	} 	
	function loadData(databaseName,tableName){
		$.get(
			"/venus/clickhouse/manager/getDistrabuteTable",
			{
				"databaseName":databaseName,
				"tableName":tableName
			},function(res){
				var data = res.pairs.retVal;
				if(data != null){
			      $("#tableId").bootstrapTable('load',data)
				}
			});
	}
	function responseHandler(res){
		return res.pairs.retVal;
	}
	function tips(msg){
		$("#tipValId").html("");
		$("#tipValId").html(msg);
		$('#tipId').modal('show')
	}
	function showColumn(){
		var arr = $("#TBListTableId").bootstrapTable('getSelections');
		if(arr == null || arr.length == 0 ){
			tips("请选择一条数据");
			return;
		}
		var row = arr[0];
		$.get(
			"/venus/clickhouse/manager/getColumn",
			{"databaseName":row.database,
			  "tableName":row.name
			},function(res){
				var data = res.pairs.retVal;
				if(data != null){
			      $("#columnTableId").bootstrapTable('load',data)
			      $("#columnDialogId").modal("show");
				}
		});
		
	}
	
  	function queryParams() {
	    var params = {}
	    $('#toolbar').find('input[name]').each(function () {
	      params[$(this).attr('name')] = $(this).val()
	    })
	    return params
	 }
  	
  	function queryData(){
  		var sql = $("#querySQLId").val();
  		sql = " select database,name,engine,engine_full,create_table_query from `system`.tables where 1 = 1 limit 10 ";
  		//var p = $("#querySQLId").format("sql",sql);
  		//console.log(p);
  		if(sql == null || sql == ''){
  			return;
  		}
		$.get("/venus/clickhouse/manager/query",
			{"sql":sql},function(res){
				var data = res.pairs.retVal;
				if(data != null && data.length > 0){
					createQueryTable(data);
				}
			});
  		
  	}
  	function createQueryTable(data){
	  	var queryTableId = "queryTableId";
  		var heads = new Array();
  		for(key in data[0]){
  			heads.push({"title":key,"field":key});
  		}
  		
  		var queryTable = $("#queryTableId");
  		queryTable.bootstrapTable( 
  				"refreshOptions",  
	              {  
	            	columns : heads
	              }  
	      );
  		queryTable.bootstrapTable('load',data)
  		
  	}
  	
  	function createTableHtml(tableId,heads){
  		var html ='<table id ="'+tableId+'" '
				  +'	data-pagination="true"'
				  +'	data-page-size="10" '
				  +'	data-toggle="table">';
		var headHtml = "";
		for(var i=0;i<heads.length;i++){
			var key = heads[i];
			headHtml +='<th data-field="'+key+'">'+key+'</th>';
		}
		html ="<thead><tr>"+headHtml+"</tr></thead>";
		return html;
  	}
  	
  	
	function getTime(){     	//获取时间
    	var date=new Date();
    	var year=date.getFullYear();
    	var month=date.getMonth();
    	var day=date.getDate();
        var hour=date.getHours();
        var minute=date.getMinutes();
        var second=date.getSeconds();
        
        if (hour<10) {
        	hour='0'+hour;
        }
        if (minute<10) {
        	minute='0'+minute;
        }
        if (second<10) {
        	second='0'+second;
        }

        var time=year+'-'+month+'-'+day+'#'+hour+':'+minute+':'+second
    	return time;
    }
</script>
</html>
